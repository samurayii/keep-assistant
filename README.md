# Keep-Assistant

## Информация

Сервис прослойка для KeepHQ, обеспечивает дополнительный функционал API.

## Оглавление

- [Установка](#install)
- [Ключи запуска](#launch)
- [Конфигурация](#configuration)
- [HTTP API](#api)

## <a name="install"></a> Установка и использование

пример строки запуска: `node /keep-assistant/app.js -c config.toml`

## <a name="launch"></a> Таблица ключей запуска
Ключ | Описание
------------ | -------------
--version, -v | вывести номер версии приложения
--help, -h | вызвать справку по ключам запуска
--config, -c | путь к файлу конфигурации в формате toml, yaml json, (переменная среды: KA_CONFIG_PATH)

## <a name="configuration"></a> Конфигурация

Программа настраивается через файл конфигурации трёх форматов TOML, YAML или JSON. Так же можно настраивать через переменные среды, которые будут считаться первичными.

### Пример файла конфигурации config.toml

```toml
[logger]                    # настройка логгера
    name = ""               # имя логгера
    enable = true           # активация
    level = "error"         # уровень (fatal, error, warn, info, debug, trace)
    timestamp = "none"      # вывод времени full, short, unix и none

[api]
    enable = false              # активация API сервера
    logging = false             # логирование запросов (ключ logger.level = "debug" или ниже)
    hostname = "0.0.0.0"        # хост          
    port = 3001                 # порт
    backlog = 511               # очередь баклога
    prefix = "/api"             # префикс
    connection_timeout = 0      # таймаут сервера в миллисекундах
    keep_alive_timeout = 5000   # таймаут keep-alive сервера в миллисекундах
    body_limit = "1mb"          # максимальный размер тела запроса (b, kb, mb)
    trust_proxy = false         # доверие proxy заголовку

[connection]                # настройка подключения к серверу keep
    hostname = ""           # имя хоста
    port = 443              # порт
    protocol = "https"      # протокол http или https
    api_key = ""            # ключ доступа
    prefix = "/"            # префикс пути
```

Оригинальный файл [тут](config_example.toml)

### Настройка через переменные среды

Ключи конфигурации можно задать через переменные среды ОС. Имя переменной среды формируется из двух частей, префикса `KA_` и имени переменной в верхнем реестре. Если переменная вложена, то это обозначается символом `_`. Переменные среды имеют высший приоритет.

пример для переменной **logger.mode**: `KA_LOGGER_MODE`

Пример для переменной **api.ips_count**: `KA_API_IPS_COUNT`

## <a name="api"></a> API

Сервис предоставляет API, который настраивается в секции файла настройки **api**. API доступно по протоколу HTTP.

### Примеры применения

проверить доступность сервера: `curl -i http://localhost:3001/healthcheck`

### API информации сервиса

| URL | Метод | Код | Описание | Пример ответа/запроса |
| ----- | ----- | ----- | ----- | ----- |
| /_ping | GET | 200 | проверить здоровье сервиса | OK |
| /healthcheck | GET | 200 | проверить здоровье сервиса | OK |
| /healthcheck/liveness | GET | 200 | проверить здоровье сервиса | OK |
| /healthcheck/readiness | GET | 200 | проверить готовность сервиса | OK |
| /healthcheck/startup | GET | 200 | проверить готовность сервиса после запуска | OK |
| /metrics | GET | 200 | получить метрики в формате Prometheus | OK |
| /api/v1/actions/silence | GET | 200 | сделать правило обслуживания (молчания) на сервере keep, параметры: duration, namespace, container, cluster_name | OK |
| /v1/actions/memorydb | GET | 200 | получить значение ключа, параметры: key | OK |
| /v1/actions/memorydb | POST | 200 | добавить ключ | [пример](#v1_add_memory_record) |

## Примеры ответов/запросов

### Базовый ответ провала

Этот ответ возвращается при отказе выполнения запроса. Пример:

```js
{
    "status": "fail",
    "message": "Причина отказа"
}
```

### Базовый ответ ошибки

Этот ответ возвращается при ошибке на сервере. Пример:

```js
{
    "status": "error",
    "message": "Причина ошибки"
}
```

### <a name="v1_add_memory_record"></a> Добавить ключ: /v1/actions/memorydb

**Тело запроса**

```js
{
    "key": "key1",           // идентификатор ключа (обязательно)
    "status": "pending",     // статус  (обязательно)
    "ttl": 15                // время жизни ключа в секундах (если не указать будет равна 240)
}
```

**Тело ответа**

```js
{
    "status": "success",
    "data": "Operation is success. Key \"key1\" added"
}
```